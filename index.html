<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alyx Steadman Therapy PLLC - Income Manager</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Income allocation and tax tracking for self-employed therapists">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="./manifest.json">

    <!-- Apple Touch Icon -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Alyx Income">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .number-mono {
            font-variant-numeric: tabular-nums;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ============================================================================
        // CONSTANTS
        // ============================================================================

        const TAX_BRACKETS_2024 = [
            { min: 0, max: 11600, rate: 0.10, base: 0 },
            { min: 11600, max: 47150, rate: 0.12, base: 1160 },
            { min: 47150, max: 100525, rate: 0.22, base: 5426 },
            { min: 100525, max: 191950, rate: 0.24, base: 17168.5 },
            { min: 191950, max: 243725, rate: 0.32, base: 39110.5 },
            { min: 243725, max: 609350, rate: 0.35, base: 55678.5 },
            { min: 609350, max: Infinity, rate: 0.37, base: 183647.25 }
        ];

        const QUARTERLY_DUE_DATES = [
            { quarter: "Q1 2025", period: "Jan 1 - Mar 31", periodEnd: "2025-03-31", due: "2025-04-15", amount: 6416 },
            { quarter: "Q2 2025", period: "Apr 1 - May 31", periodEnd: "2025-05-31", due: "2025-06-15", amount: 6416 },
            { quarter: "Q3 2025", period: "Jun 1 - Aug 31", periodEnd: "2025-08-31", due: "2025-09-15", amount: 6416 },
            { quarter: "Q4 2025", period: "Sep 1 - Dec 31", periodEnd: "2025-12-31", due: "2026-01-15", amount: 6416 }
        ];

        const DEFAULT_SETTINGS = {
            tax2024Total: 25664,
            quarterlyPayment: 6416,
            standardDeduction: 14600,
            startingTaxSavingsBalance: 0,
            startDate: "2025-01-01",
            currentYear: 2025,
            businessName: "Alyx Steadman Therapy PLLC"
        };

        const STORAGE_KEY = "alyxIncomeManager";
        const STORAGE_VERSION = "1.0";

        // ============================================================================
        // TAX CALCULATION FUNCTIONS
        // ============================================================================

        /**
         * Calculate self-employment tax
         * @param {number} netIncome - Net income after business expenses
         * @returns {object} { seTax, seTaxDeduction }
         */
        function calculateSelfEmploymentTax(netIncome) {
            const seTaxBase = netIncome * 0.9235;
            const seTax = seTaxBase * 0.153; // 15.3% (12.4% SS + 2.9% Medicare)
            const seTaxDeduction = seTax * 0.5; // Deduct half of SE tax
            return { seTax, seTaxDeduction, seTaxBase };
        }

        /**
         * Calculate income tax using 2024 tax brackets (single filer)
         * @param {number} netIncome - Net income after business expenses
         * @param {number} seTaxDeduction - Half of self-employment tax
         * @param {number} standardDeduction - Standard deduction amount
         * @returns {object} { incomeTax, taxableIncome, adjustedIncome }
         */
        function calculateIncomeTax(netIncome, seTaxDeduction, standardDeduction = 14600) {
            const adjustedIncome = netIncome - seTaxDeduction;
            const taxableIncome = Math.max(0, adjustedIncome - standardDeduction);

            let incomeTax = 0;
            let bracketDetails = [];

            for (const bracket of TAX_BRACKETS_2024) {
                if (taxableIncome <= bracket.min) break;

                const taxableInBracket = Math.min(taxableIncome, bracket.max) - bracket.min;
                const taxFromBracket = taxableInBracket * bracket.rate;

                if (taxableInBracket > 0) {
                    bracketDetails.push({
                        min: bracket.min,
                        max: bracket.max,
                        rate: bracket.rate,
                        taxableAmount: taxableInBracket,
                        tax: taxFromBracket
                    });
                    incomeTax += taxFromBracket;
                }
            }

            // Add the base from the appropriate bracket
            for (const bracket of TAX_BRACKETS_2024) {
                if (taxableIncome > bracket.min && taxableIncome <= bracket.max) {
                    incomeTax = bracket.base + (taxableIncome - bracket.min) * bracket.rate;
                    break;
                }
            }

            return { incomeTax, taxableIncome, adjustedIncome, bracketDetails };
        }

        /**
         * Calculate total tax liability
         * @param {number} netIncome - Net income after business expenses
         * @param {number} standardDeduction - Standard deduction amount
         * @returns {object} Complete tax calculation breakdown
         */
        function calculateTotalTax(netIncome, standardDeduction = 14600) {
            const { seTax, seTaxDeduction, seTaxBase } = calculateSelfEmploymentTax(netIncome);
            const { incomeTax, taxableIncome, adjustedIncome, bracketDetails } =
                calculateIncomeTax(netIncome, seTaxDeduction, standardDeduction);

            return {
                netIncome,
                seTax,
                seTaxDeduction,
                seTaxBase,
                incomeTax,
                taxableIncome,
                adjustedIncome,
                totalTax: seTax + incomeTax,
                bracketDetails
            };
        }

        /**
         * Calculate smart weekly tax savings based on current progress and projections
         * @param {number} weeklyIncome - This week's income
         * @param {number} ytdIncome - Year-to-date income
         * @param {number} weeksElapsed - Number of weeks completed
         * @param {number} taxSavingsBalance - Current tax savings balance
         * @param {object} settings - App settings
         * @returns {object} { amount, percentage, status, explanation }
         */
        function calculateSmartTaxSavings(weeklyIncome, ytdIncome, weeksElapsed, taxSavingsBalance, quarterlyPaid, settings) {
            // If it's the very first week, use safe harbor amount as baseline
            if (weeksElapsed === 0) {
                const weeklyTarget = settings.tax2024Total / 52;
                return {
                    amount: weeklyTarget,
                    percentage: (weeklyTarget / weeklyIncome) * 100,
                    status: 'baseline',
                    explanation: 'First week - using safe harbor baseline',
                    projectedTax: settings.tax2024Total
                };
            }

            // Calculate projected annual income based on current pace
            const avgWeekly = ytdIncome / weeksElapsed;
            const projectedAnnual = avgWeekly * 52;

            // Calculate projected 2025 tax
            const projectedTax = calculateTotalTax(projectedAnnual, settings.standardDeduction);

            // We need enough to cover the HIGHER of:
            // 1. Safe harbor (2024 tax) - to avoid penalties
            // 2. Projected 2025 tax - to avoid owing at tax time
            const totalNeeded = Math.max(settings.tax2024Total, projectedTax.totalTax);

            // How much more do we need to save?
            // Account for both current savings AND quarterly payments already made
            const stillNeed = totalNeeded - (taxSavingsBalance + quarterlyPaid);

            // Weeks remaining (including current week)
            const weeksRemaining = 52 - weeksElapsed;

            // Calculate weekly target
            let weeklyTarget = 0;
            let status = 'on-track';
            let explanation = '';

            if (weeksRemaining <= 0) {
                // End of year
                weeklyTarget = Math.max(0, stillNeed);
                status = stillNeed > 0 ? 'behind' : 'complete';
                explanation = stillNeed > 0 ? 'Final catch-up needed' : 'Year complete!';
            } else {
                weeklyTarget = stillNeed / weeksRemaining;

                if (weeklyTarget < 0) {
                    weeklyTarget = 0;
                    status = 'ahead';
                    explanation = `You're ahead of target! No tax savings needed this week.`;
                } else {
                    const percentage = (weeklyTarget / weeklyIncome) * 100;
                    if (percentage < 25) {
                        status = 'on-track';
                        explanation = `On track - saving ${percentage.toFixed(0)}% this week.`;
                    } else if (percentage < 35) {
                        status = 'slightly-behind';
                        explanation = `Slightly behind - need to save ${percentage.toFixed(0)}% this week.`;
                    } else {
                        status = 'behind';
                        explanation = `Behind on taxes - need to save ${percentage.toFixed(0)}% to catch up.`;
                    }
                }
            }

            return {
                amount: Math.max(0, weeklyTarget),
                percentage: weeklyIncome > 0 ? (weeklyTarget / weeklyIncome) * 100 : 0,
                status,
                explanation,
                projectedTax: projectedTax.totalTax,
                totalNeeded,
                stillNeed: Math.max(0, stillNeed),
                weeksRemaining
            };
        }

        // ============================================================================
        // DATE HELPER FUNCTIONS
        // ============================================================================

        /**
         * Get ISO week number for a date
         */
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        /**
         * Get Friday of a specific week
         */
        function getFridayOfWeek(weekNumber, year) {
            const jan4 = new Date(year, 0, 4);
            const jan4Day = jan4.getDay() || 7;
            const weekStart = new Date(year, 0, 4 - jan4Day + 1 + (weekNumber - 1) * 7);
            const friday = new Date(weekStart);
            friday.setDate(weekStart.getDate() + 5); // Add 5 days to get Friday
            return friday;
        }

        /**
         * Get current week number
         */
        function getCurrentWeek() {
            return getWeekNumber(new Date());
        }

        /**
         * Format date as readable string
         */
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        /**
         * Get days until a date
         */
        function getDaysUntil(dateString) {
            const target = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            target.setHours(0, 0, 0, 0);
            const diff = target - today;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }

        // ============================================================================
        // EXPENSE CALCULATION FUNCTIONS
        // ============================================================================

        /**
         * Calculate bills due in the next N days
         */
        function calculateUpcomingBills(currentDate, expenseBudget, dueDates, daysAhead = 14) {
            if (!expenseBudget || !dueDates) return [];

            const today = new Date(currentDate);
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + daysAhead);

            const upcomingBills = [];
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // Check current month and next month
            for (let monthOffset = 0; monthOffset <= 1; monthOffset++) {
                const checkMonth = (currentMonth + monthOffset) % 12;
                const checkYear = currentMonth + monthOffset >= 12 ? currentYear + 1 : currentYear;

                for (const [expense, dueDay] of Object.entries(dueDates)) {
                    if (!expenseBudget[expense]) continue;

                    const dueDate = new Date(checkYear, checkMonth, dueDay);

                    if (dueDate >= today && dueDate <= endDate) {
                        const amount = expenseBudget[expense][checkMonth] || 0;
                        if (amount > 0) {
                            upcomingBills.push({
                                expense,
                                amount,
                                dueDate: dueDate.toISOString().split('T')[0],
                                dueDateFormatted: formatDate(dueDate.toISOString())
                            });
                        }
                    }
                }
            }

            return upcomingBills.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        }

        // Rolling 4-week business expense calculation
        function calculateRolling4WeekBusiness(weekDate, expenseBudget, dueDates) {
            if (!expenseBudget || !dueDates || Object.keys(dueDates).length === 0) {
                return {
                    weeklyAmount: 0,
                    totalIn4Weeks: 0,
                    billsFound: []
                };
            }

            const startDate = new Date(weekDate);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 28); // 4 weeks including current week

            const billsIn4Weeks = [];

            // Check each expense
            for (const [expense, dueDay] of Object.entries(dueDates)) {
                if (!expenseBudget[expense]) continue;

                // Check current month
                const currentMonth = startDate.getMonth();
                const currentYear = startDate.getFullYear();
                const currentMonthDue = new Date(currentYear, currentMonth, dueDay);

                if (currentMonthDue >= startDate && currentMonthDue <= endDate) {
                    const amount = expenseBudget[expense][currentMonth] || 0;
                    if (amount > 0) {
                        billsIn4Weeks.push({
                            expense,
                            dueDate: currentMonthDue.toISOString().split('T')[0],
                            amount
                        });
                    }
                }

                // Check next month
                const nextMonth = (currentMonth + 1) % 12;
                const nextYear = nextMonth === 0 ? currentYear + 1 : currentYear;
                const nextMonthDue = new Date(nextYear, nextMonth, dueDay);

                if (nextMonthDue >= startDate && nextMonthDue <= endDate) {
                    const amount = expenseBudget[expense][nextMonth] || 0;
                    if (amount > 0) {
                        billsIn4Weeks.push({
                            expense,
                            dueDate: nextMonthDue.toISOString().split('T')[0],
                            amount
                        });
                    }
                }
            }

            const totalIn4Weeks = billsIn4Weeks.reduce((sum, bill) => sum + bill.amount, 0);
            const weeklyAmount = totalIn4Weeks / 4;

            return {
                weeklyAmount,
                totalIn4Weeks,
                billsFound: billsIn4Weeks
            };
        }

        // ============================================================================
        // LOCAL STORAGE FUNCTIONS
        // ============================================================================

        function saveToLocalStorage(data) {
            try {
                const saveData = {
                    version: STORAGE_VERSION,
                    timestamp: new Date().toISOString(),
                    ...data
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (!data) return null;
                return JSON.parse(data);
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        function exportToJSON() {
            const data = loadFromLocalStorage();
            if (!data) return null;

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alyx-income-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================================================
        // CSV FUNCTIONS
        // ============================================================================

        function parseExpenseCSV(csvText) {
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            const budget = {};
                            const dueDates = {};
                            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                            results.data.forEach(row => {
                                const expenseName = row.Expense;
                                if (!expenseName) return;

                                budget[expenseName] = months.map(month => {
                                    const value = parseFloat(row[month] || 0);
                                    return isNaN(value) ? 0 : value;
                                });

                                // Read due day from CSV (default to 1 if not provided or invalid)
                                const dueDay = parseInt(row.DueDay || 1);
                                dueDates[expenseName] = (dueDay >= 1 && dueDay <= 31) ? dueDay : 1;
                            });

                            resolve({ budget, dueDates });
                        } catch (error) {
                            reject(error);
                        }
                    },
                    error: (error) => {
                        reject(error);
                    }
                });
            });
        }

        function exportWeeksToCSV(weeks) {
            // Metadata header
            const exportDate = new Date().toISOString();
            const metadata = [
                '# Alyx Steadman Therapy PLLC - Income Manager',
                `# Version: ${STORAGE_VERSION}`,
                `# Exported: ${exportDate}`,
                ''
            ].join('\n');

            const headers = ['Week', 'Date', 'Income', 'Business', 'Tax', 'Paycheck', 'Notes'];
            const rows = weeks
                .filter(w => w.income !== null)
                .map(w => [
                    w.week,
                    w.date,
                    w.income?.toFixed(2) || '0.00',
                    w.business?.toFixed(2) || '0.00',
                    w.tax?.toFixed(2) || '0.00',
                    w.paycheck?.toFixed(2) || '0.00',
                    w.notes || ''
                ]);

            const csv = metadata + [headers, ...rows].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alyx-income-history-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateExpenseTemplate(appData = null) {
            let csvContent;
            let filename;

            // Check if user has existing budget data (with safe property access)
            const hasBudget = appData && appData.expenses && appData.expenses.budget && Object.keys(appData.expenses.budget).length > 0;

            if (hasBudget) {
                // Generate CSV from current budget
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const header = 'Expense,DueDay,' + months.join(',');
                const rows = [];

                // Build rows from budget data
                for (const [expenseName, monthlyAmounts] of Object.entries(appData.expenses.budget)) {
                    const dueDay = appData.expenses.dueDates[expenseName] || 1;
                    const row = `${expenseName},${dueDay},${monthlyAmounts.join(',')}`;
                    rows.push(row);
                }

                csvContent = header + '\n' + rows.join('\n');
                filename = 'my-expense-budget.csv';
            } else {
                // Use the empty template
                csvContent = `Expense,DueDay,Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec
SimplePractice,1,87,87,87,87,87,87,87,87,87,87,87,87
Rent,1,410,410,410,410,410,410,410,410,410,410,410,410
Phone,15,123,123,123,123,123,123,123,123,123,123,123,123
Internet,20,55,55,93,222,93,93,93,93,108,143,108,108
Supervision,5,360,360,425,510,425,425,350,350,350,870,870,870
Books,10,10,10,10,10,10,10,10,10,10,10,10,10
Trainings,1,600,75,75,75,75,75,75,75,75,75,75,75
Insurance,1,0,0,0,0,292,0,0,0,0,0,0,0
License,1,0,0,0,0,0,95,0,41,0,0,0,200`;
                filename = 'expense-budget-template.csv';
            }

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================================================
        // MAIN APP COMPONENT
        // ============================================================================

        function App() {
            const [currentScreen, setCurrentScreen] = useState('dashboard');
            const [appData, setAppData] = useState(null);
            const [isSetupComplete, setIsSetupComplete] = useState(false);
            const [setupStep, setSetupStep] = useState(1);

            // Initialize app data
            useEffect(() => {
                const savedData = loadFromLocalStorage();

                if (savedData && savedData.settings && savedData.settings.setupComplete) {
                    setAppData(savedData);
                    setIsSetupComplete(true);
                } else {
                    // Initialize with default data
                    const initialData = {
                        settings: { ...DEFAULT_SETTINGS, setupComplete: false },
                        expenses: {
                            budget: {},
                            dueDates: {}
                        },
                        weeks: Array.from({ length: 52 }, (_, i) => ({
                            week: i + 1,
                            date: getFridayOfWeek(i + 1, 2025).toISOString().split('T')[0],
                            income: null,
                            business: null,
                            tax: null,
                            paycheck: null,
                            notes: '',
                            status: 'pending'
                        })),
                        quarterlyPayments: QUARTERLY_DUE_DATES.map(q => ({ ...q, paid: false, datePaid: null })),
                        businessTransactions: [],
                        taxTransactions: []
                    };
                    setAppData(initialData);
                    setIsSetupComplete(false);
                }
            }, []);

            // Save data whenever it changes
            useEffect(() => {
                if (appData) {
                    saveToLocalStorage(appData);
                }
            }, [appData]);

            const updateSettings = (newSettings) => {
                setAppData(prev => ({
                    ...prev,
                    settings: { ...prev.settings, ...newSettings }
                }));
            };

            const updateWeek = (weekNumber, weekData) => {
                setAppData(prev => ({
                    ...prev,
                    weeks: prev.weeks.map(w =>
                        w.week === weekNumber ? { ...w, ...weekData, status: 'completed' } : w
                    )
                }));
            };

            const updateQuarterlyPayment = (quarter, paid, datePaid = null) => {
                setAppData(prev => ({
                    ...prev,
                    quarterlyPayments: prev.quarterlyPayments.map(q =>
                        q.quarter === quarter ? { ...q, paid, datePaid } : q
                    )
                }));
            };

            const updateExpenses = (budget, dueDates) => {
                setAppData(prev => ({
                    ...prev,
                    expenses: { budget, dueDates }
                }));
            };

            if (!appData) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-xl text-gray-600">Loading...</div>
                    </div>
                );
            }

            if (!isSetupComplete) {
                return (
                    <SetupFlow
                        appData={appData}
                        setAppData={setAppData}
                        setupStep={setupStep}
                        setSetupStep={setSetupStep}
                        onComplete={() => {
                            updateSettings({ setupComplete: true });
                            setIsSetupComplete(true);
                        }}
                    />
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <Navigation currentScreen={currentScreen} setCurrentScreen={setCurrentScreen} />

                    <div className="container mx-auto px-4 py-6 max-w-4xl">
                        {currentScreen === 'dashboard' && (
                            <Dashboard appData={appData} updateWeek={updateWeek} updateSettings={updateSettings} setCurrentScreen={setCurrentScreen} />
                        )}
                        {currentScreen === 'history' && (
                            <History appData={appData} updateWeek={updateWeek} />
                        )}
                        {currentScreen === 'taxes' && (
                            <Taxes appData={appData} updateQuarterlyPayment={updateQuarterlyPayment} />
                        )}
                        {currentScreen === 'expenses' && (
                            <Expenses appData={appData} updateExpenses={updateExpenses} updateSettings={updateSettings} />
                        )}
                        {currentScreen === 'settings' && (
                            <Settings appData={appData} updateSettings={updateSettings} setAppData={setAppData} />
                        )}
                    </div>
                </div>
            );
        }

        // ============================================================================
        // NAVIGATION COMPONENT
        // ============================================================================

        function Navigation({ currentScreen, setCurrentScreen }) {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                { id: 'history', label: 'History', icon: 'üìÖ' },
                { id: 'taxes', label: 'Taxes', icon: 'üí∞' },
                { id: 'expenses', label: 'Expenses', icon: 'üè¢' },
                { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' }
            ];

            return (
                <nav className="bg-white shadow-md sticky top-0 z-50">
                    <div className="container mx-auto px-4">
                        <div className="flex space-x-1 overflow-x-auto">
                            {navItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentScreen(item.id)}
                                    className={`px-4 py-3 whitespace-nowrap font-medium transition-colors ${
                                        currentScreen === item.id
                                            ? 'text-blue-600 border-b-2 border-blue-600'
                                            : 'text-gray-600 hover:text-blue-600'
                                    }`}
                                >
                                    <span className="mr-2">{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </nav>
            );
        }

        // ============================================================================
        // SETUP FLOW COMPONENT
        // ============================================================================

        function SetupFlow({ appData, setAppData, setupStep, setSetupStep, onComplete }) {
            const [tax2024, setTax2024] = useState(appData.settings.tax2024Total);
            const [csvFile, setCsvFile] = useState(null);
            const [dueDates, setDueDates] = useState({});
            const [startingTaxSavings, setStartingTaxSavings] = useState(appData.settings.startingTaxSavingsBalance);

            const handleCsvUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const text = await file.text();
                try {
                    const { budget, dueDates: parsedDueDates } = await parseExpenseCSV(text);
                    setCsvFile(budget);
                    setDueDates(parsedDueDates);
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    alert('Error parsing CSV file. Please check the format.');
                }
            };

            const handleFinishSetup = () => {
                setAppData(prev => ({
                    ...prev,
                    settings: {
                        ...prev.settings,
                        tax2024Total: tax2024,
                        quarterlyPayment: Math.round(tax2024 / 4),
                        startingTaxSavingsBalance: startingTaxSavings
                    },
                    expenses: {
                        budget: csvFile || {},
                        dueDates: dueDates
                    }
                }));
                onComplete();
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full">
                        {setupStep === 1 && (
                            <div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-4">
                                    Welcome to {appData.settings.businessName}
                                </h1>
                                <h2 className="text-xl text-gray-600 mb-6">Income Manager</h2>
                                <p className="text-gray-700 mb-8">
                                    Let's set up your account. This will take about 5 minutes.
                                </p>
                                <button
                                    onClick={() => setSetupStep(2)}
                                    className="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                >
                                    Get Started
                                </button>
                            </div>
                        )}

                        {setupStep === 2 && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">Step 1: Tax Information</h2>
                                <div className="mb-6">
                                    <label className="block text-gray-700 mb-2 font-semibold">
                                        What was your total 2024 tax?
                                    </label>
                                    <p className="text-sm text-gray-600 mb-4">
                                        This is used to calculate quarterly estimated payments for 2025.
                                    </p>
                                    <div className="relative">
                                        <span className="absolute left-3 top-3 text-gray-500">$</span>
                                        <input
                                            type="number"
                                            value={tax2024}
                                            onChange={(e) => setTax2024(parseFloat(e.target.value) || 0)}
                                            className="w-full pl-8 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                            placeholder="25664"
                                        />
                                    </div>
                                    <p className="text-sm text-gray-500 mt-2">
                                        Don't know? Check your 2024 tax return, Form 1040, Line 24.
                                    </p>
                                    <p className="text-sm text-blue-600 mt-2 font-semibold">
                                        Your quarterly payment will be: ${Math.round(tax2024 / 4).toLocaleString()}
                                    </p>
                                </div>
                                <div className="flex gap-4">
                                    <button
                                        onClick={() => setSetupStep(1)}
                                        className="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors"
                                    >
                                        Back
                                    </button>
                                    <button
                                        onClick={() => setSetupStep(3)}
                                        className="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        Next
                                    </button>
                                </div>
                            </div>
                        )}

                        {setupStep === 3 && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">Step 2: Expense Budget</h2>
                                <div className="mb-6">
                                    <p className="text-gray-700 mb-4">
                                        Upload your monthly expense budget as a CSV file.
                                    </p>
                                    <div className="mb-4">
                                        <input
                                            type="file"
                                            accept=".csv"
                                            onChange={handleCsvUpload}
                                            className="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 cursor-pointer"
                                        />
                                    </div>
                                    <button
                                        onClick={generateExpenseTemplate}
                                        className="text-blue-600 hover:underline text-sm"
                                    >
                                        üì• Download Template First
                                    </button>
                                    {csvFile && (
                                        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                                            <p className="text-green-700 font-semibold">
                                                ‚úì Budget uploaded successfully!
                                            </p>
                                            <p className="text-sm text-green-600 mt-1">
                                                Found {Object.keys(csvFile).length} expense categories
                                            </p>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-4">
                                    <button
                                        onClick={() => setSetupStep(2)}
                                        className="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors"
                                    >
                                        Back
                                    </button>
                                    <button
                                        onClick={() => setSetupStep(4)}
                                        className="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        {csvFile ? 'Next' : 'Skip - I\'ll Do This Later'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {setupStep === 4 && csvFile && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">Step 3: Bill Due Dates</h2>
                                <p className="text-gray-700 mb-4">When are your bills due each month?</p>
                                <div className="space-y-3 mb-6 max-h-96 overflow-y-auto">
                                    {Object.keys(csvFile).map(expense => (
                                        <div key={expense} className="flex items-center gap-4">
                                            <label className="flex-1 text-gray-700">{expense}:</label>
                                            <select
                                                value={dueDates[expense] || 1}
                                                onChange={(e) => setDueDates(prev => ({
                                                    ...prev,
                                                    [expense]: parseInt(e.target.value)
                                                }))}
                                                className="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                            >
                                                {Array.from({ length: 31 }, (_, i) => i + 1).map(day => (
                                                    <option key={day} value={day}>
                                                        {day}{day === 1 ? 'st' : day === 2 ? 'nd' : day === 3 ? 'rd' : 'th'}
                                                    </option>
                                                ))}
                                            </select>
                                            <span className="text-gray-500">of month</span>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4">
                                    <button
                                        onClick={() => setSetupStep(3)}
                                        className="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors"
                                    >
                                        Back
                                    </button>
                                    <button
                                        onClick={() => setSetupStep(5)}
                                        className="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        Next
                                    </button>
                                </div>
                            </div>
                        )}

                        {((setupStep === 4 && !csvFile) || setupStep === 5) && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">
                                    Step {csvFile ? '4' : '3'}: Starting Tax Savings Balance
                                </h2>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-gray-700 mb-2 font-semibold">
                                            Tax Savings Balance
                                        </label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-3 text-gray-500">$</span>
                                            <input
                                                type="number"
                                                value={startingTaxSavings}
                                                onChange={(e) => setStartingTaxSavings(parseFloat(e.target.value) || 0)}
                                                className="w-full pl-8 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                            />
                                        </div>
                                        <p className="text-sm text-gray-600 mt-2">
                                            Enter the amount you currently have saved for taxes (if any).
                                        </p>
                                    </div>
                                </div>
                                <div className="flex gap-4">
                                    <button
                                        onClick={() => setSetupStep(csvFile ? 4 : 3)}
                                        className="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors"
                                    >
                                        Back
                                    </button>
                                    <button
                                        onClick={() => setSetupStep(6)}
                                        className="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        Finish Setup
                                    </button>
                                </div>
                            </div>
                        )}

                        {setupStep === 6 && (
                            <div className="text-center">
                                <div className="text-6xl mb-6">‚úÖ</div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Setup Complete!</h2>
                                <p className="text-gray-700 mb-8">
                                    You're ready to start tracking your income and managing your business.
                                </p>
                                <button
                                    onClick={handleFinishSetup}
                                    className="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                >
                                    Go to Dashboard
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ============================================================================
        // DASHBOARD COMPONENT
        // ============================================================================

        function Dashboard({ appData, updateWeek, updateSettings, setCurrentScreen }) {
            const [weeklyIncome, setWeeklyIncome] = useState('');
            const [showSplit, setShowSplit] = useState(false);
            const [showBusinessDetails, setShowBusinessDetails] = useState(false);
            const [showTaxDetails, setShowTaxDetails] = useState(false);
            const [calculatedSplit, setCalculatedSplit] = useState(null);
            const [catchUpMode, setCatchUpMode] = useState(false);
            const [missingWeekIncomes, setMissingWeekIncomes] = useState({});
            const [missingWeekTaxes, setMissingWeekTaxes] = useState({});
            const [missingWeekPaychecks, setMissingWeekPaychecks] = useState({});
            const [csvImportFormat, setCsvImportFormat] = useState(null); // '2-column' or '4-column'
            const [catchUpCsvFile, setCatchUpCsvFile] = useState(null);
            const [showQuarterlyWarning, setShowQuarterlyWarning] = useState(false);
            const [unpaidQuarters, setUnpaidQuarters] = useState([]);
            const [isManualAdjust, setIsManualAdjust] = useState(false);
            const [manualBusiness, setManualBusiness] = useState('');
            const [manualTax, setManualTax] = useState('');
            const [manualPaycheck, setManualPaycheck] = useState('');

            const currentWeek = getCurrentWeek();
            const currentWeekData = appData.weeks.find(w => w.week === currentWeek);

            // Calculate YTD totals
            const completedWeeks = appData.weeks.filter(w => w.income !== null);
            const weeksElapsed = completedWeeks.length;
            const ytdIncome = completedWeeks.reduce((sum, w) => sum + (w.income || 0), 0);
            const ytdTaxSavings = completedWeeks.reduce((sum, w) => sum + (w.tax || 0), 0);
            const ytdBusiness = completedWeeks.reduce((sum, w) => sum + (w.business || 0), 0);
            const ytdPaychecks = completedWeeks.reduce((sum, w) => sum + (w.paycheck || 0), 0);

            // Calculate current balances
            const quarterlyPaid = appData.quarterlyPayments
                .filter(q => q.paid)
                .reduce((sum, q) => sum + q.amount, 0);
            const taxSavingsBalance = appData.settings.startingTaxSavingsBalance + ytdTaxSavings - quarterlyPaid;

            // Calculate projections
            const averageWeekly = weeksElapsed > 0 ? ytdIncome / weeksElapsed : 0;
            const projectedAnnual = averageWeekly * 52;
            const projectedTax = calculateTotalTax(projectedAnnual, appData.settings.standardDeduction);

            // Next quarterly payment
            const nextQuarterly = appData.quarterlyPayments.find(q => !q.paid);
            const daysUntilNext = nextQuarterly ? getDaysUntil(nextQuarterly.periodEnd) : null;

            // Missing weeks
            const missingWeeks = appData.weeks.filter(w =>
                w.week < currentWeek && w.income === null
            );

            const handleCalculateSplit = () => {
                const income = parseFloat(weeklyIncome);
                if (isNaN(income) || income <= 0) {
                    alert('Please enter a valid income amount');
                    return;
                }

                // Calculate business expenses using rolling 4-week method
                const rolling4Week = calculateRolling4WeekBusiness(
                    currentWeekData.date,
                    appData.expenses.budget,
                    appData.expenses.dueDates
                );

                // Calculate business expenses first (capped at 50% of income)
                const business = Math.min(rolling4Week.weeklyAmount, income * 0.5);

                // Calculate smart tax savings
                const smartTax = calculateSmartTaxSavings(
                    income,
                    ytdIncome,
                    weeksElapsed,
                    taxSavingsBalance,
                    quarterlyPaid,
                    appData.settings
                );

                // Cap tax at what's available after business expenses
                // Never save more than what's left after business
                const maxTaxAvailable = income - business;
                const tax = Math.min(smartTax.amount, maxTaxAvailable);

                // Calculate paycheck (what's left)
                const paycheck = Math.max(0, income - business - tax);

                // Add warning if we had to cap the tax
                const isTaxCapped = smartTax.amount > maxTaxAvailable;
                const cappedSmartTax = {
                    ...smartTax,
                    amount: tax,
                    isCapped: isTaxCapped,
                    idealAmount: smartTax.amount,
                    shortfall: isTaxCapped ? smartTax.amount - tax : 0
                };

                setCalculatedSplit({
                    income,
                    business,
                    tax,
                    paycheck,
                    rolling4Week,
                    smartTax: cappedSmartTax
                });
                setShowSplit(true);
            };

            const handleRecordWeek = () => {
                if (!calculatedSplit) return;

                updateWeek(currentWeek, {
                    income: calculatedSplit.income,
                    business: calculatedSplit.business,
                    tax: calculatedSplit.tax,
                    paycheck: calculatedSplit.paycheck
                });

                setWeeklyIncome('');
                setShowSplit(false);
                setCalculatedSplit(null);

                alert('Week recorded successfully! üéâ');
            };

            const handleEnterMissingWeeks = () => {
                // Check if any missing weeks span quarterly payment due dates
                const affectedQuarters = [];

                if (missingWeeks.length > 0) {
                    const firstMissingWeek = missingWeeks[0];
                    const lastMissingWeek = missingWeeks[missingWeeks.length - 1];
                    const firstDate = new Date(firstMissingWeek.date);
                    const lastDate = new Date(lastMissingWeek.date);

                    // Check each quarterly payment
                    appData.quarterlyPayments.forEach((payment, index) => {
                        const dueDate = new Date(QUARTERLY_DUE_DATES[index].due);

                        // If the due date falls within or before the missing weeks range
                        // and the payment is NOT paid, add it to affected quarters
                        if (dueDate >= firstDate && dueDate <= lastDate && !payment.paid) {
                            affectedQuarters.push({
                                quarter: payment.quarter,
                                dueDate: QUARTERLY_DUE_DATES[index].due,
                                period: QUARTERLY_DUE_DATES[index].period
                            });
                        }
                    });
                }

                // If there are unpaid quarterly payments in the range, show warning
                if (affectedQuarters.length > 0) {
                    setUnpaidQuarters(affectedQuarters);
                    setShowQuarterlyWarning(true);
                } else {
                    // No warning needed, proceed with catch-up mode
                    openCatchUpMode();
                }
            };

            const openCatchUpMode = () => {
                setCatchUpMode(true);
                // Initialize income values for missing weeks
                const initialIncomes = {};
                missingWeeks.forEach(w => {
                    initialIncomes[w.week] = '';
                });
                setMissingWeekIncomes(initialIncomes);
            };

            const handleCatchUpCsvUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setCatchUpCsvFile(file);

                // Parse CSV file
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            // Detect CSV format by checking headers
                            const headers = results.meta.fields || [];
                            const hasTax = headers.some(h => h.toLowerCase() === 'tax');
                            const hasPaycheck = headers.some(h => h.toLowerCase() === 'paycheck');
                            const is4Column = hasTax && hasPaycheck;

                            const incomes = {};
                            const taxes = {};
                            const paychecks = {};
                            let errorMessages = [];

                            results.data.forEach((row, index) => {
                                // Clean and parse week number
                                const weekStr = (row.Week || row.week || '').toString().trim();
                                const week = parseInt(weekStr);

                                // Clean and parse income (remove $, commas, and whitespace)
                                const incomeStr = (row.Income || row.income || '').toString().trim();
                                const cleanedIncome = incomeStr.replace(/[$,\s]/g, '');
                                const income = parseFloat(cleanedIncome);

                                // Validate week number
                                if (isNaN(week) || week < 1 || week > 52) {
                                    errorMessages.push(`Row ${index + 2}: Invalid week number "${weekStr}"`);
                                    return;
                                }

                                // Validate income value
                                if (isNaN(income) || income < 0) {
                                    errorMessages.push(`Row ${index + 2}: Invalid income "${incomeStr}"`);
                                    return;
                                }

                                incomes[week] = income.toString();

                                // Parse Tax and Paycheck if this is a 4-column import
                                if (is4Column) {
                                    const taxStr = (row.Tax || row.tax || '0').toString().trim();
                                    const cleanedTax = taxStr.replace(/[$,\s]/g, '');
                                    const tax = parseFloat(cleanedTax) || 0;

                                    const paycheckStr = (row.Paycheck || row.paycheck || '0').toString().trim();
                                    const cleanedPaycheck = paycheckStr.replace(/[$,\s]/g, '');
                                    const paycheck = parseFloat(cleanedPaycheck) || 0;

                                    if (tax < 0 || paycheck < 0) {
                                        errorMessages.push(`Row ${index + 2}: Tax and Paycheck must be non-negative`);
                                        return;
                                    }

                                    taxes[week] = tax.toString();
                                    paychecks[week] = paycheck.toString();
                                }
                            });

                            if (errorMessages.length > 0) {
                                alert('CSV Upload Errors:\n\n' + errorMessages.join('\n'));
                                return;
                            }

                            if (Object.keys(incomes).length === 0) {
                                alert('No valid data found in CSV. Make sure your CSV has "Week" and "Income" columns.');
                                return;
                            }

                            // Set the import format
                            setCsvImportFormat(is4Column ? '4-column' : '2-column');

                            // Merge with existing data (CSV takes precedence)
                            setMissingWeekIncomes(prev => ({ ...prev, ...incomes }));

                            if (is4Column) {
                                setMissingWeekTaxes(prev => ({ ...prev, ...taxes }));
                                setMissingWeekPaychecks(prev => ({ ...prev, ...paychecks }));
                                alert(`Successfully loaded ${Object.keys(incomes).length} week(s) from CSV in Historical format (4-column)!`);
                            } else {
                                alert(`Successfully loaded ${Object.keys(incomes).length} week(s) from CSV in Simple format (2-column)!`);
                            }

                        } catch (error) {
                            alert('Error parsing CSV: ' + error.message);
                        }
                    },
                    error: (error) => {
                        alert('Error reading CSV file: ' + error.message);
                    }
                });
            };

            const handleRecordMissingWeeks = () => {
                // Calculate splits for each week and record them
                // Process in week number order to get accurate running totals
                const sortedEntries = Object.entries(missingWeekIncomes)
                    .sort(([a], [b]) => parseInt(a) - parseInt(b));

                let recordedCount = 0;
                let runningYtdIncome = ytdIncome;
                let runningWeeksElapsed = weeksElapsed;
                let runningTaxBalance = taxSavingsBalance;

                // Check if this is a 4-column import (historical with actual amounts)
                const is4ColumnImport = csvImportFormat === '4-column';
                const lastWeekNum = sortedEntries.length > 0 ? sortedEntries[sortedEntries.length - 1][0] : null;

                // If 4-column, calculate total pool for balancing
                let totalIncome = 0;
                let totalTax = 0;
                let totalPaycheck = 0;

                if (is4ColumnImport) {
                    sortedEntries.forEach(([weekNum, income]) => {
                        const incomeValue = parseFloat(income) || 0;
                        const taxValue = parseFloat(missingWeekTaxes[weekNum]) || 0;
                        const paycheckValue = parseFloat(missingWeekPaychecks[weekNum]) || 0;
                        totalIncome += incomeValue;
                        totalTax += taxValue;
                        totalPaycheck += paycheckValue;
                    });
                }

                sortedEntries.forEach(([weekNum, income], index) => {
                    const incomeValue = parseFloat(income);
                    if (!isNaN(incomeValue) && incomeValue > 0) {
                        const isLastWeek = is4ColumnImport && (weekNum === lastWeekNum);

                        let business, tax, paycheck;

                        if (is4ColumnImport) {
                            // Use actual tax and paycheck from CSV
                            tax = parseFloat(missingWeekTaxes[weekNum]) || 0;
                            paycheck = parseFloat(missingWeekPaychecks[weekNum]) || 0;

                            if (isLastWeek) {
                                // Last week gets the balancing business amount
                                business = totalIncome - totalTax - totalPaycheck;
                            } else {
                                // All other weeks: business = 0
                                business = 0;
                            }
                        } else {
                            // 2-column import: calculate splits normally
                            const weekData = appData.weeks.find(w => w.week === parseInt(weekNum));
                            const weekDate = new Date(weekData.date);

                            // Calculate business expenses using rolling 4-week method
                            const rolling4Week = calculateRolling4WeekBusiness(
                                weekDate,
                                appData.expenses.budget,
                                appData.expenses.dueDates
                            );

                            // Cap business at 50% of income
                            business = Math.min(rolling4Week.weeklyAmount, incomeValue * 0.5);

                            // Calculate smart tax for this week
                            const smartTax = calculateSmartTaxSavings(
                                incomeValue,
                                runningYtdIncome,
                                runningWeeksElapsed,
                                runningTaxBalance,
                                quarterlyPaid,
                                appData.settings
                            );

                            // Cap tax at what's available (income - business)
                            tax = Math.min(smartTax.amount, incomeValue - business);
                            paycheck = incomeValue - business - tax;
                        }

                        updateWeek(parseInt(weekNum), {
                            income: incomeValue,
                            business: business,
                            tax: tax,
                            paycheck: paycheck
                        });

                        // Update running totals for next week's calculation
                        runningYtdIncome += incomeValue;
                        runningWeeksElapsed += 1;
                        runningTaxBalance += tax;

                        recordedCount++;
                    }
                });

                if (recordedCount > 0) {
                    alert(`${recordedCount} week(s) recorded successfully! üéâ`);
                }

                setCatchUpMode(false);
                setMissingWeekIncomes({});
                setMissingWeekTaxes({});
                setMissingWeekPaychecks({});
                setCsvImportFormat(null);
            };

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h1 className="text-2xl font-bold text-gray-800">{appData.settings.businessName}</h1>
                        <p className="text-gray-600">Week {currentWeek} of 52 ({formatDate(currentWeekData.date)})</p>
                    </div>

                    {/* Missing Weeks Alert */}
                    {missingWeeks.length > 0 && (
                        <div className="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6">
                            <h3 className="text-lg font-bold text-yellow-800 mb-2">‚ö†Ô∏è MISSING INCOME DATA</h3>
                            <p className="text-yellow-700 mb-3">You haven't entered income for:</p>
                            <ul className="list-disc list-inside text-yellow-700 mb-4">
                                {missingWeeks.slice(0, 5).map(w => (
                                    <li key={w.week}>Week {w.week} ({formatDate(w.date)})</li>
                                ))}
                                {missingWeeks.length > 5 && (
                                    <li>... and {missingWeeks.length - 5} more</li>
                                )}
                            </ul>
                            <button
                                onClick={handleEnterMissingWeeks}
                                className="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors"
                            >
                                Enter Missing Weeks
                            </button>
                        </div>
                    )}

                    {/* Quarterly Payment Warning Modal */}
                    {showQuarterlyWarning && (
                        <div className="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6 mb-6">
                            <h3 className="text-lg font-bold text-yellow-800 mb-3">‚ö†Ô∏è QUARTERLY TAX PAYMENTS</h3>
                            <p className="text-yellow-700 mb-4">
                                The weeks you're entering span these quarterly payment due dates:
                            </p>
                            <ul className="list-disc list-inside text-yellow-700 mb-4 space-y-1">
                                {unpaidQuarters.map(q => (
                                    <li key={q.quarter}>
                                        <strong>{q.quarter}</strong> ({q.period}) - Due {formatDate(q.dueDate)} - <span className="text-red-600 font-semibold">NOT PAID</span>
                                    </li>
                                ))}
                            </ul>
                            <div className="bg-white border border-yellow-300 rounded-lg p-4 mb-4">
                                <p className="text-sm text-gray-700">
                                    <strong>For accurate tax calculations:</strong> If you've already paid these quarterly taxes in real life,
                                    you should mark them as PAID in the Tax Tracking screen before entering historical weeks.
                                    This ensures the smart tax calculation doesn't think you're further behind than you actually are.
                                </p>
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => {
                                        setShowQuarterlyWarning(false);
                                        setCurrentScreen('taxes');
                                    }}
                                    className="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                >
                                    Go to Tax Tracking
                                </button>
                                <button
                                    onClick={() => {
                                        setShowQuarterlyWarning(false);
                                        openCatchUpMode();
                                    }}
                                    className="flex-1 bg-yellow-600 text-white px-4 py-3 rounded-lg hover:bg-yellow-700 transition-colors"
                                >
                                    Continue Anyway
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Catch-Up Mode */}
                    {catchUpMode && (
                        <div className="bg-white rounded-lg shadow-md p-6 border-2 border-blue-500">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">CATCH-UP MODE: ENTER MISSING WEEKS</h2>
                            <p className="text-gray-600 mb-4">
                                Enter income for each week below. For bulk imports, see Settings ‚Üí Import Past Weeks.
                            </p>

                            {/* Manual Entry */}
                            <h3 className="font-semibold text-gray-800 mb-3">‚úçÔ∏è Enter Income for Each Week</h3>

                            <div className="space-y-4 mb-6">
                                {missingWeeks.map(week => (
                                    <div key={week.week} className="border border-gray-300 rounded-lg p-4">
                                        <h3 className="font-semibold text-gray-800 mb-2">
                                            Week {week.week} ({formatDate(week.date)})
                                        </h3>
                                        <div className="flex gap-3 items-center">
                                            <label className="text-gray-700">Income:</label>
                                            <div className="relative flex-1">
                                                <span className="absolute left-3 top-2 text-gray-500">$</span>
                                                <input
                                                    type="number"
                                                    value={missingWeekIncomes[week.week] || ''}
                                                    onChange={(e) => setMissingWeekIncomes(prev => ({
                                                        ...prev,
                                                        [week.week]: e.target.value
                                                    }))}
                                                    className="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                                    placeholder="0.00"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
                                <h3 className="font-semibold text-blue-800 mb-2">Summary</h3>
                                <div className="text-blue-700">
                                    {(() => {
                                        const totalIncome = Object.values(missingWeekIncomes).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);

                                        // Calculate splits using smart tax and rolling 4-week business (simulating sequential weeks)
                                        const sortedEntries = Object.entries(missingWeekIncomes).sort(([a], [b]) => parseInt(a) - parseInt(b));
                                        let runningYtd = ytdIncome;
                                        let runningWeeks = weeksElapsed;
                                        let runningTax = taxSavingsBalance;
                                        let totalTax = 0;
                                        let totalBusiness = 0;

                                        sortedEntries.forEach(([weekNum, income]) => {
                                            const incomeValue = parseFloat(income) || 0;
                                            if (incomeValue > 0) {
                                                // Get the week's date
                                                const weekData = appData.weeks.find(w => w.week === parseInt(weekNum));
                                                const weekDate = new Date(weekData.date);

                                                // Calculate business using rolling 4-week method
                                                const rolling4Week = calculateRolling4WeekBusiness(
                                                    weekDate,
                                                    appData.expenses.budget,
                                                    appData.expenses.dueDates
                                                );
                                                const business = Math.min(rolling4Week.weeklyAmount, incomeValue * 0.5);

                                                const smartTax = calculateSmartTaxSavings(incomeValue, runningYtd, runningWeeks, runningTax, quarterlyPaid, appData.settings);
                                                // Cap tax at available amount
                                                const tax = Math.min(smartTax.amount, incomeValue - business);
                                                totalBusiness += business;
                                                totalTax += tax;
                                                runningYtd += incomeValue;
                                                runningWeeks += 1;
                                                runningTax += tax;
                                            }
                                        });

                                        const totalPaycheck = totalIncome - totalBusiness - totalTax;
                                        const avgTaxRate = totalIncome > 0 ? (totalTax / totalIncome) * 100 : 0;
                                        const avgBusinessRate = totalIncome > 0 ? (totalBusiness / totalIncome) * 100 : 0;

                                        return (
                                            <>
                                                <div>Total Income: ${totalIncome.toFixed(2)}</div>
                                                <div>Business (~{avgBusinessRate.toFixed(1)}%): ${totalBusiness.toFixed(2)}</div>
                                                <div>Tax ( ~{avgTaxRate.toFixed(1)}%): ${totalTax.toFixed(2)}</div>
                                                <div>Paycheck: ${totalPaycheck.toFixed(2)}</div>
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>

                            <div className="flex gap-4">
                                <button
                                    onClick={handleRecordMissingWeeks}
                                    className="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                >
                                    ‚úì Record These Weeks
                                </button>
                                <button
                                    onClick={() => {
                                        setCatchUpMode(false);
                                        setMissingWeekIncomes({});
                                        setMissingWeekTaxes({});
                                        setMissingWeekPaychecks({});
                                        setCsvImportFormat(null);
                                        setCatchUpCsvFile(null);
                                    }}
                                    className="flex-1 bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300 transition-colors"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}

                    {/* YTD Summary */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">üìä YEAR TO DATE SUMMARY</h2>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <div className="text-sm text-gray-600">Total Income</div>
                                <div className="text-2xl font-bold text-gray-800 number-mono">
                                    ${ytdIncome.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </div>
                            </div>
                            <div>
                                <div className="text-sm text-gray-600">Total Tax</div>
                                <div className="text-2xl font-bold text-green-600 number-mono">
                                    ${ytdTaxSavings.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </div>
                            </div>
                            <div>
                                <div className="text-sm text-gray-600">Total Business</div>
                                <div className="text-2xl font-bold text-blue-600 number-mono">
                                    ${ytdBusiness.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </div>
                            </div>
                            <div>
                                <div className="text-sm text-gray-600">Paid to Self</div>
                                <div className="text-2xl font-bold text-purple-600 number-mono">
                                    ${ytdPaychecks.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Current Tax Savings Balance */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">üí∞ CURRENT TAX SAVINGS BALANCE</h2>
                        <div className="flex flex-col items-center">
                            <div className="text-sm text-gray-600 mb-2">Tax Savings Account</div>
                            <div className="text-4xl font-bold text-green-600 number-mono mb-3">
                                ${taxSavingsBalance.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                            </div>
                            <div className="text-xs text-gray-500 text-center">
                                This is what you should currently have in your tax savings account
                            </div>
                        </div>
                    </div>

                    {/* Quarterly Tax Status */}
                    {nextQuarterly && (
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">üìÖ QUARTERLY TAX STATUS</h2>
                            <div className="space-y-3">
                                <div>
                                    <span className="text-gray-600">Next Payment: </span>
                                    <span className="font-semibold">{nextQuarterly.quarter}</span>
                                </div>
                                <div>
                                    <span className="text-gray-600">Period Ends: </span>
                                    <span className="font-semibold">{formatDate(nextQuarterly.periodEnd)}</span>
                                    <span className="text-sm text-gray-500 ml-2">({daysUntilNext} days)</span>
                                </div>
                                <div>
                                    <span className="text-gray-600">Payment Due: </span>
                                    <span className="font-semibold">{formatDate(nextQuarterly.due)}</span>
                                </div>
                                <div>
                                    <span className="text-gray-600">Amount: </span>
                                    <span className="font-semibold number-mono">
                                        ${nextQuarterly.amount.toLocaleString()}
                                    </span>
                                </div>
                                <div>
                                    <span className="text-gray-600">Currently Saved: </span>
                                    <span className={`font-semibold number-mono ${
                                        taxSavingsBalance >= nextQuarterly.amount ? 'text-green-600' : 'text-red-600'
                                    }`}>
                                        ${taxSavingsBalance.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                        {taxSavingsBalance >= nextQuarterly.amount && ' ‚úì'}
                                    </span>
                                </div>
                                <div className={`mt-4 p-3 rounded-lg ${
                                    taxSavingsBalance >= nextQuarterly.amount
                                        ? 'bg-green-50 text-green-700'
                                        : 'bg-yellow-50 text-yellow-700'
                                }`}>
                                    <strong>Status: </strong>
                                    {taxSavingsBalance >= nextQuarterly.amount
                                        ? 'COVERED ‚úì'
                                        : `Need $${(nextQuarterly.amount - taxSavingsBalance).toLocaleString()} more`
                                    }
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Year-End Tax Projection */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">‚ö†Ô∏è YEAR-END TAX PROJECTION</h2>
                        <div className="space-y-3">
                            <div>
                                <span className="text-gray-600">Based on current pace: </span>
                                <span className="font-semibold number-mono">
                                    ${projectedAnnual.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}/year
                                </span>
                            </div>
                            <div>
                                <span className="text-gray-600">Projected 2025 tax: </span>
                                <span className="font-semibold number-mono">
                                    ~${projectedTax.totalTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </span>
                            </div>
                            <div>
                                <span className="text-gray-600">Quarterly payments: </span>
                                <span className="font-semibold number-mono">
                                    ${appData.settings.tax2024Total.toLocaleString()}
                                </span>
                            </div>
                            <div>
                                <span className="text-gray-600">Additional due at end of year: </span>
                                <span className={`font-semibold number-mono ${
                                    projectedTax.totalTax > appData.settings.tax2024Total ? 'text-blue-800' : 'text-green-600'
                                }`}>
                                    ~${Math.max(0, projectedTax.totalTax - appData.settings.tax2024Total).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* Enter Weekly Income */}
                    {!showSplit && currentWeekData.income === null && (
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">üíµ ENTER THIS WEEK'S INCOME</h2>
                            <p className="text-gray-600 mb-4">
                                Week {currentWeek} ending Friday, {formatDate(currentWeekData.date)}
                            </p>
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label className="block text-gray-700 mb-2">Income received:</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-3 text-gray-500">$</span>
                                        <input
                                            type="number"
                                            value={weeklyIncome}
                                            onChange={(e) => setWeeklyIncome(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleCalculateSplit()}
                                            className="w-full pl-8 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg"
                                            placeholder="2850.00"
                                        />
                                    </div>
                                </div>
                                <div className="flex items-end">
                                    <button
                                        onClick={handleCalculateSplit}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                    >
                                        Calculate My Split
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Show Split */}
                    {showSplit && calculatedSplit && (
                        <div className="bg-white rounded-lg shadow-md p-6 border-2 border-blue-500">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">HERE'S YOUR SPLIT FOR THIS WEEK</h2>

                            <div className="mb-6">
                                <div className="text-gray-600">üí∞ Income Received:</div>
                                <div className="text-3xl font-bold text-gray-800 number-mono">
                                    ${calculatedSplit.income.toFixed(2)}
                                </div>
                            </div>

                            <div className="border-t-2 border-b-2 border-gray-200 py-6 space-y-4">
                                {/* Business Expenses */}
                                <div>
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="text-lg font-semibold text-gray-800">
                                                üè¢ Business Expenses:
                                                <span className="ml-2 number-mono">${calculatedSplit.business.toFixed(2)}</span>
                                            </div>
                                            <div className="text-sm text-gray-600">Reserve for upcoming bills</div>
                                        </div>
                                        <button
                                            onClick={() => setShowBusinessDetails(!showBusinessDetails)}
                                            className="text-blue-600 hover:underline text-sm"
                                        >
                                            {showBusinessDetails ? 'Hide Details ‚ñ≤' : 'Show Details ‚ñº'}
                                        </button>
                                    </div>

                                    {showBusinessDetails && calculatedSplit.businessReserve && (
                                        <div className="mt-3 p-4 bg-gray-50 rounded-lg text-sm">
                                            <div className="space-y-2">
                                                <div>
                                                    <div className="font-semibold text-gray-700 mb-2">Bills due in next 4 weeks:</div>
                                                    {calculatedSplit.rolling4Week.billsFound.map((bill, i) => (
                                                        <div key={i} className="ml-4 text-gray-600">
                                                            ‚Ä¢ {bill.dueDate} - {bill.expense}: ${bill.amount.toFixed(2)}
                                                        </div>
                                                    ))}
                                                    <div className="mt-2 font-semibold">
                                                        Total in next 4 weeks: ${calculatedSplit.rolling4Week.totalIn4Weeks.toFixed(2)}
                                                    </div>
                                                    <div className="text-sm text-gray-600 mt-1">
                                                        Weekly amount: ${calculatedSplit.rolling4Week.weeklyAmount.toFixed(2)} (√∑ 4)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Tax Savings */}
                                <div>
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="text-lg font-semibold text-gray-800">
                                                üíæ Tax Savings ({calculatedSplit.smartTax.percentage.toFixed(1)}%):
                                                <span className="ml-2 number-mono">${calculatedSplit.tax.toFixed(2)}</span>
                                            </div>
                                            <div className={`text-sm font-medium ${
                                                calculatedSplit.smartTax.status === 'ahead' ? 'text-green-600' :
                                                calculatedSplit.smartTax.status === 'on-track' ? 'text-blue-600' :
                                                calculatedSplit.smartTax.status === 'slightly-behind' ? 'text-yellow-600' :
                                                'text-red-600'
                                            }`}>
                                                {calculatedSplit.smartTax.explanation}
                                            </div>
                                            {calculatedSplit.smartTax.isCapped && (
                                                <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700">
                                                    <strong>‚ö†Ô∏è Warning:</strong> Ideally need ${calculatedSplit.smartTax.idealAmount.toFixed(2)} for taxes, but only ${calculatedSplit.tax.toFixed(2)} available after business expenses. Shortfall: ${calculatedSplit.smartTax.shortfall.toFixed(2)} this week.
                                                </div>
                                            )}
                                        </div>
                                        <button
                                            onClick={() => setShowTaxDetails(!showTaxDetails)}
                                            className="text-blue-600 hover:underline text-sm"
                                        >
                                            {showTaxDetails ? 'Hide Details ‚ñ≤' : 'Show Details ‚ñº'}
                                        </button>
                                    </div>

                                    {showTaxDetails && (
                                        <div className="mt-3 p-4 bg-gray-50 rounded-lg text-sm">
                                            <div className="space-y-2">
                                                <div className="font-semibold text-gray-700">Smart Tax Calculation</div>
                                                <div className="space-y-1">
                                                    <div>‚Ä¢ Weeks completed: {weeksElapsed}</div>
                                                    <div>‚Ä¢ Weeks remaining: {calculatedSplit.smartTax.weeksRemaining}</div>
                                                    <div>‚Ä¢ YTD income: ${ytdIncome.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                                    <div>‚Ä¢ Current tax savings: ${taxSavingsBalance.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                                </div>
                                                <div className="mt-3">
                                                    <div className="font-semibold text-gray-700 mb-1">What you need by year-end:</div>
                                                    <div>‚Ä¢ Safe harbor (2024 tax): ${appData.settings.tax2024Total.toLocaleString()}</div>
                                                    <div>‚Ä¢ Projected 2025 tax: ${calculatedSplit.smartTax.projectedTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                                    <div className="font-semibold mt-1">‚Ä¢ Target (higher of both): ${calculatedSplit.smartTax.totalNeeded.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                                </div>
                                                <div className="mt-3">
                                                    <div className="font-semibold text-gray-700">Still need to save: ${calculatedSplit.smartTax.stillNeed.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                                    <div className="text-xs text-gray-600 mt-1">
                                                        Divided by {calculatedSplit.smartTax.weeksRemaining} weeks = ${calculatedSplit.smartTax.amount.toFixed(2)}/week
                                                    </div>
                                                </div>
                                                <div className="mt-3">
                                                    <div>After this week: ${(taxSavingsBalance + calculatedSplit.tax).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Paycheck */}
                            <div className="mt-6 p-6 bg-green-50 border-2 border-green-500 rounded-lg">
                                <div className="text-lg text-green-800 mb-2">üíµ PAY YOURSELF:</div>
                                <div className="text-4xl font-bold text-green-600 number-mono mb-2">
                                    ${calculatedSplit.paycheck.toFixed(2)}
                                </div>
                                <div className="text-sm text-green-700">‚úì Safe to transfer to personal account</div>
                            </div>

                            {/* Action Buttons */}
                            <div className="mt-6 flex gap-4">
                                <button
                                    onClick={handleRecordWeek}
                                    className="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                >
                                    ‚úì Record This Week
                                </button>
                                <button
                                    onClick={() => {
                                        setIsManualAdjust(true);
                                        setManualBusiness(calculatedSplit.business.toFixed(2));
                                        setManualTax(calculatedSplit.tax.toFixed(2));
                                        setManualPaycheck(calculatedSplit.paycheck.toFixed(2));
                                    }}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors"
                                >
                                    ‚úèÔ∏è Adjust Amounts
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Manual Adjustment Mode */}
                    {isManualAdjust && calculatedSplit && (
                        <div className="bg-white rounded-lg shadow-md p-6 border-2 border-orange-500">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">MANUALLY ADJUST AMOUNTS</h2>

                            <div className="mb-4 p-3 bg-gray-50 rounded-lg">
                                <div className="text-sm text-gray-600">Income Received:</div>
                                <div className="text-2xl font-bold text-gray-800 number-mono">
                                    ${calculatedSplit.income.toFixed(2)}
                                </div>
                            </div>

                            <div className="space-y-4 mb-4">
                                <div>
                                    <label className="block text-gray-700 font-semibold mb-2">üè¢ Business Expenses:</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-3 text-gray-500">$</span>
                                        <input
                                            type="number"
                                            value={manualBusiness}
                                            onChange={(e) => {
                                                setManualBusiness(e.target.value);
                                                const b = parseFloat(e.target.value) || 0;
                                                const t = parseFloat(manualTax) || 0;
                                                setManualPaycheck((calculatedSplit.income - b - t).toFixed(2));
                                            }}
                                            className="w-full pl-8 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-gray-700 font-semibold mb-2">üíæ Tax Savings:</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-3 text-gray-500">$</span>
                                        <input
                                            type="number"
                                            value={manualTax}
                                            onChange={(e) => {
                                                setManualTax(e.target.value);
                                                const b = parseFloat(manualBusiness) || 0;
                                                const t = parseFloat(e.target.value) || 0;
                                                setManualPaycheck((calculatedSplit.income - b - t).toFixed(2));
                                            }}
                                            className="w-full pl-8 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-gray-700 font-semibold mb-2">üíµ Paycheck:</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-3 text-gray-500">$</span>
                                        <input
                                            type="number"
                                            value={manualPaycheck}
                                            onChange={(e) => {
                                                setManualPaycheck(e.target.value);
                                            }}
                                            className="w-full pl-8 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg bg-gray-50"
                                            disabled
                                        />
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">Auto-calculated: Income - Business - Tax</div>
                                </div>
                            </div>

                            {(() => {
                                const b = parseFloat(manualBusiness) || 0;
                                const t = parseFloat(manualTax) || 0;
                                const p = parseFloat(manualPaycheck) || 0;
                                const total = b + t + p;
                                const diff = Math.abs(total - calculatedSplit.income);
                                const isValid = diff < 0.01;

                                return (
                                    <>
                                        <div className={`p-3 rounded-lg mb-4 ${isValid ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
                                            <div className="text-sm">
                                                <strong>Total:</strong> ${total.toFixed(2)}
                                                {!isValid && (
                                                    <span className="text-red-600 ml-2">
                                                        (Should equal ${calculatedSplit.income.toFixed(2)})
                                                    </span>
                                                )}
                                                {isValid && <span className="text-green-600 ml-2">‚úì Amounts match!</span>}
                                            </div>
                                        </div>
                                        {p < 0 && (
                                            <div className="p-3 bg-yellow-50 border border-yellow-300 rounded-lg mb-4 text-sm">
                                                <strong>‚ö†Ô∏è Note:</strong> Negative paycheck (${p.toFixed(2)}) means you're transferring money FROM your personal account back to business/tax accounts. This is valid if you're catching up on savings.
                                            </div>
                                        )}
                                    </>
                                );
                            })()}

                            <div className="flex gap-4">
                                <button
                                    onClick={() => {
                                        const b = parseFloat(manualBusiness) || 0;
                                        const t = parseFloat(manualTax) || 0;
                                        const p = parseFloat(manualPaycheck) || 0;
                                        const total = b + t + p;
                                        const diff = Math.abs(total - calculatedSplit.income);

                                        if (diff >= 0.01) {
                                            alert('Amounts must add up to total income!');
                                            return;
                                        }

                                        updateWeek(currentWeek, {
                                            income: calculatedSplit.income,
                                            business: b,
                                            tax: t,
                                            paycheck: p
                                        });

                                        setWeeklyIncome('');
                                        setShowSplit(false);
                                        setCalculatedSplit(null);
                                        setIsManualAdjust(false);

                                        alert('Week recorded with custom amounts! üéâ');
                                    }}
                                    className="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                >
                                    ‚úì Record with Adjustments
                                </button>
                                <button
                                    onClick={() => {
                                        setIsManualAdjust(false);
                                    }}
                                    className="flex-1 bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300 transition-colors"
                                >
                                    ‚Üê Back to Auto
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Already recorded */}
                    {currentWeekData.income !== null && (
                        <div className="bg-green-50 border-2 border-green-500 rounded-lg p-6">
                            <h2 className="text-xl font-bold text-green-800 mb-4">‚úÖ Week {currentWeek} Already Recorded</h2>
                            <div className="space-y-2">
                                <div>Income: <span className="font-semibold number-mono">${currentWeekData.income.toFixed(2)}</span></div>
                                <div>Business: <span className="font-semibold number-mono">${currentWeekData.business.toFixed(2)}</span></div>
                                <div>Tax: <span className="font-semibold number-mono">${currentWeekData.tax.toFixed(2)}</span></div>
                                <div>Paycheck: <span className="font-semibold number-mono">${currentWeekData.paycheck.toFixed(2)}</span></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ============================================================================
        // HISTORY COMPONENT
        // ============================================================================

        function History({ appData, updateWeek }) {
            const [editingWeek, setEditingWeek] = useState(null);
            const [editIncome, setEditIncome] = useState('');
            const [editBusiness, setEditBusiness] = useState('');
            const [editTax, setEditTax] = useState('');
            const [editPaycheck, setEditPaycheck] = useState('');

            const completedWeeks = appData.weeks.filter(w => w.income !== null).reverse();

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-2xl font-bold text-gray-800">üìÖ WEEKLY INCOME HISTORY</h1>
                            <div className="flex gap-2">
                                {completedWeeks.length > 0 && (
                                    <button
                                        onClick={() => {
                                            const latestWeek = completedWeeks[0]; // Already reversed, so first is latest
                                            if (confirm(`Delete Week ${latestWeek.week} (${formatDate(latestWeek.date)})?\n\nIncome: $${latestWeek.income.toFixed(2)}\n\nThis cannot be undone.`)) {
                                                updateWeek(latestWeek.week, {
                                                    income: null,
                                                    business: null,
                                                    tax: null,
                                                    paycheck: null
                                                });
                                                alert('Week deleted! ‚úì');
                                            }
                                        }}
                                        className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
                                    >
                                        üóëÔ∏è Delete Latest Week
                                    </button>
                                )}
                                <button
                                    onClick={() => exportWeeksToCSV(appData.weeks)}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                                >
                                    üì• Export to CSV
                                </button>
                            </div>
                        </div>
                        <p className="text-gray-600">
                            {completedWeeks.length} of 52 weeks recorded
                        </p>
                    </div>

                    <div className="space-y-4">
                        {completedWeeks.map(week => (
                            <div key={week.week} className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-800">
                                            Week {week.week} ({formatDate(week.date)})
                                        </h3>
                                    </div>
                                    <button
                                        onClick={() => {
                                            setEditingWeek(week.week);
                                            setEditIncome(week.income.toFixed(2));
                                            setEditBusiness(week.business.toFixed(2));
                                            setEditTax(week.tax.toFixed(2));
                                            setEditPaycheck(week.paycheck.toFixed(2));
                                        }}
                                        className="text-blue-600 hover:underline text-sm"
                                    >
                                        ‚úèÔ∏è Edit
                                    </button>
                                </div>

                                {editingWeek === week.week ? (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            <div>
                                                <label className="block text-sm text-gray-600 mb-1">Income</label>
                                                <div className="relative">
                                                    <span className="absolute left-2 top-2 text-gray-500 text-sm">$</span>
                                                    <input
                                                        type="number"
                                                        value={editIncome}
                                                        onChange={(e) => setEditIncome(e.target.value)}
                                                        className="w-full pl-6 pr-2 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-600 mb-1">Business</label>
                                                <div className="relative">
                                                    <span className="absolute left-2 top-2 text-gray-500 text-sm">$</span>
                                                    <input
                                                        type="number"
                                                        value={editBusiness}
                                                        onChange={(e) => setEditBusiness(e.target.value)}
                                                        className="w-full pl-6 pr-2 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-600 mb-1">Tax</label>
                                                <div className="relative">
                                                    <span className="absolute left-2 top-2 text-gray-500 text-sm">$</span>
                                                    <input
                                                        type="number"
                                                        value={editTax}
                                                        onChange={(e) => setEditTax(e.target.value)}
                                                        className="w-full pl-6 pr-2 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm text-gray-600 mb-1">Paycheck</label>
                                                <div className="relative">
                                                    <span className="absolute left-2 top-2 text-gray-500 text-sm">$</span>
                                                    <input
                                                        type="number"
                                                        value={editPaycheck}
                                                        onChange={(e) => setEditPaycheck(e.target.value)}
                                                        className="w-full pl-6 pr-2 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex gap-3 mt-4">
                                            <button
                                                onClick={() => {
                                                    const income = parseFloat(editIncome) || 0;
                                                    const business = parseFloat(editBusiness) || 0;
                                                    const tax = parseFloat(editTax) || 0;
                                                    const paycheck = parseFloat(editPaycheck) || 0;

                                                    updateWeek(week.week, {
                                                        income,
                                                        business,
                                                        tax,
                                                        paycheck
                                                    });

                                                    setEditingWeek(null);
                                                    alert('Week updated! ‚úì');
                                                }}
                                                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                                            >
                                                ‚úì Save Changes
                                            </button>
                                            <button
                                                onClick={() => setEditingWeek(null)}
                                                className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div>
                                            <div className="text-sm text-gray-600">Income</div>
                                            <div className="text-lg font-semibold text-gray-800 number-mono">
                                                ${week.income.toFixed(2)}
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-sm text-gray-600">‚Üí Business</div>
                                            <div className="text-lg font-semibold text-blue-600 number-mono">
                                                ${week.business.toFixed(2)}
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-sm text-gray-600">‚Üí Tax</div>
                                            <div className="text-lg font-semibold text-green-600 number-mono">
                                                ${week.tax.toFixed(2)}
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-sm text-gray-600">‚Üí Paycheck</div>
                                            <div className="text-lg font-semibold text-purple-600 number-mono">
                                                ${week.paycheck.toFixed(2)}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}

                        {completedWeeks.length === 0 && (
                            <div className="bg-gray-50 rounded-lg p-12 text-center">
                                <p className="text-gray-500 text-lg">No weeks recorded yet</p>
                                <p className="text-gray-400 mt-2">Go to the Dashboard to enter your first week!</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ============================================================================
        // TAXES COMPONENT
        // ============================================================================

        function Taxes({ appData, updateQuarterlyPayment }) {
            const [showCalculation, setShowCalculation] = useState(false);

            const completedWeeks = appData.weeks.filter(w => w.income !== null);
            const weeksElapsed = completedWeeks.length;
            const ytdIncome = completedWeeks.reduce((sum, w) => sum + (w.income || 0), 0);
            const ytdTaxSavings = completedWeeks.reduce((sum, w) => sum + (w.tax || 0), 0);

            const quarterlyPaid = appData.quarterlyPayments
                .filter(q => q.paid)
                .reduce((sum, q) => sum + q.amount, 0);
            const taxSavingsBalance = appData.settings.startingTaxSavingsBalance + ytdTaxSavings - quarterlyPaid;

            const averageWeekly = weeksElapsed > 0 ? ytdIncome / weeksElapsed : 0;
            const projectedAnnual = averageWeekly * 52;
            const projectedTax = calculateTotalTax(projectedAnnual, appData.settings.standardDeduction);

            const totalQuarterly = appData.settings.tax2024Total;
            const additionalNeeded = Math.max(0, projectedTax.totalTax - totalQuarterly);

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h1 className="text-2xl font-bold text-gray-800">üí∞ TAX TRACKING & PROJECTIONS</h1>
                    </div>

                    {/* Quarterly Payments */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">QUARTERLY PAYMENTS</h2>
                        <p className="text-gray-600 mb-4">
                            Based on 2024 tax: ${totalQuarterly.toLocaleString()}
                        </p>

                        <div className="space-y-4">
                            {appData.quarterlyPayments.map(payment => {
                                const daysUntil = getDaysUntil(payment.due);
                                const isPast = daysUntil < 0;

                                return (
                                    <div
                                        key={payment.quarter}
                                        className={`p-4 rounded-lg border-2 ${
                                            payment.paid
                                                ? 'bg-green-50 border-green-500'
                                                : isPast
                                                    ? 'bg-red-50 border-red-500'
                                                    : 'bg-yellow-50 border-yellow-500'
                                        }`}
                                    >
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1">
                                                <h3 className="font-semibold text-gray-800 mb-1">
                                                    {payment.quarter} - Due {formatDate(payment.due)}
                                                </h3>
                                                <div className="text-sm text-gray-600 mb-2">{payment.period}</div>
                                                <div className="text-lg font-semibold number-mono">
                                                    Amount: ${payment.amount.toLocaleString()}
                                                </div>
                                                {!payment.paid && (
                                                    <div className="text-sm mt-1">
                                                        {isPast ? (
                                                            <span className="text-red-600 font-semibold">OVERDUE by {Math.abs(daysUntil)} days</span>
                                                        ) : (
                                                            <span className="text-yellow-600">Due in {daysUntil} days</span>
                                                        )}
                                                    </div>
                                                )}
                                                {payment.paid && (
                                                    <div className="mt-2 space-y-2">
                                                        <div className="text-sm text-green-600">
                                                            ‚úÖ PAID
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <label className="text-xs text-gray-600">Date paid:</label>
                                                            <input
                                                                type="date"
                                                                value={payment.datePaid?.split('T')[0] || ''}
                                                                onChange={(e) => updateQuarterlyPayment(payment.quarter, true, e.target.value)}
                                                                className="text-sm px-2 py-1 border border-gray-300 rounded focus:border-blue-500 focus:outline-none"
                                                            />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            <div>
                                                {payment.paid ? (
                                                    <button
                                                        onClick={() => updateQuarterlyPayment(payment.quarter, false, null)}
                                                        className="text-sm text-gray-600 hover:underline"
                                                    >
                                                        Mark Unpaid
                                                    </button>
                                                ) : (
                                                    <button
                                                        onClick={() => updateQuarterlyPayment(payment.quarter, true, new Date().toISOString().split('T')[0])}
                                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                                                    >
                                                        Mark as Paid
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Year-End Projection */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">YEAR-END PROJECTION</h2>

                        <div className="space-y-3 mb-4">
                            <div>
                                <span className="text-gray-600">YTD Income ({weeksElapsed} weeks):</span>
                                <span className="ml-2 font-semibold number-mono">
                                    ${ytdIncome.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </span>
                            </div>
                            <div>
                                <span className="text-gray-600">Projected annual:</span>
                                <span className="ml-2 font-semibold number-mono">
                                    ${projectedAnnual.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </span>
                            </div>
                        </div>

                        <button
                            onClick={() => setShowCalculation(!showCalculation)}
                            className="text-blue-600 hover:underline mb-4"
                        >
                            {showCalculation ? 'Hide' : 'Show'} Full Calculation ‚ñº
                        </button>

                        {showCalculation && (
                            <div className="p-4 bg-gray-50 rounded-lg mb-4 text-sm">
                                <h4 className="font-semibold mb-3">DETAILED TAX CALCULATION</h4>

                                <div className="space-y-2 mb-4">
                                    <div className="font-semibold">Projected 2025 income: ${projectedAnnual.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>

                                    <div className="mt-3 font-semibold">SELF-EMPLOYMENT TAX:</div>
                                    <div className="ml-4">
                                        <div>Net income: ${projectedAnnual.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                        <div>√ó 0.9235 = ${projectedTax.seTaxBase.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} (SE tax base)</div>
                                        <div>√ó 0.153 = ${projectedTax.seTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} (SE tax)</div>
                                        <div>√∑ 2 = ${projectedTax.seTaxDeduction.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} (SE tax deduction)</div>
                                    </div>

                                    <div className="mt-3 font-semibold">INCOME TAX:</div>
                                    <div className="ml-4">
                                        <div>Adjusted income: ${projectedAnnual.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} - ${projectedTax.seTaxDeduction.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                        <div>= ${projectedTax.adjustedIncome.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                        <div>Standard deduction: -${appData.settings.standardDeduction.toLocaleString()}</div>
                                        <div>Taxable income: ${projectedTax.taxableIncome.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                        <div className="mt-2">Income tax total: ${projectedTax.incomeTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                    </div>

                                    <div className="mt-3 font-semibold text-lg">
                                        TOTAL TAX: ${projectedTax.seTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} + ${projectedTax.incomeTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} = ${projectedTax.totalTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="space-y-2 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div>
                                <span className="text-gray-700">‚Ä¢ Self-employment tax:</span>
                                <span className="ml-2 font-semibold number-mono">
                                    ~${projectedTax.seTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </span>
                            </div>
                            <div>
                                <span className="text-gray-700">‚Ä¢ Income tax:</span>
                                <span className="ml-2 font-semibold number-mono">
                                    ~${projectedTax.incomeTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </span>
                            </div>
                            <div className="pt-2 border-t border-blue-300">
                                <span className="text-gray-700 font-semibold">‚Ä¢ Total projected tax:</span>
                                <span className="ml-2 font-semibold number-mono text-lg">
                                    ~${projectedTax.totalTax.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </span>
                            </div>
                        </div>

                        <div className="mt-4 space-y-2">
                            <div>
                                <span className="text-gray-600">Quarterly payments:</span>
                                <span className="ml-2 font-semibold number-mono">
                                    ${totalQuarterly.toLocaleString()}
                                </span>
                            </div>
                            <div>
                                <span className="text-gray-600">Additional beyond estimated quaterly payments:</span>
                                <span className={`ml-2 font-semibold number-mono ${
                                    additionalNeeded > 0 ? 'text-gray-700' : 'text-green-600'
                                }`}>
                                    ~${additionalNeeded.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </span>
                            </div>
                            <div>
                                <span className="text-gray-600">Current tax savings:</span>
                                <span className="ml-2 font-semibold number-mono">
                                    ${taxSavingsBalance.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                </span>
                            </div>
                            <div className={`mt-3 p-3 rounded-lg ${
                                (taxSavingsBalance + quarterlyPaid) >= projectedTax.totalTax
                                    ? 'bg-green-50 text-green-700'
                                    : 'bg-yellow-50 text-yellow-700'
                            }`}>
                                <strong>Status: </strong>
                                {(taxSavingsBalance + quarterlyPaid) >= projectedTax.totalTax
                                    ? `On track! You have enough saved. ‚úì`
                                    : `Behind by ~$${(projectedTax.totalTax - (quarterlyPaid + taxSavingsBalance)).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`
                                }
                            </div>
                        </div>

                        <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p className="text-blue-800 text-sm">
                                Keep saving each week using the tax calculation - you'll catch up as more income comes in!
                            </p>
                        </div>
                    </div>

                    {/* Tax Savings Account */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">TAX SAVINGS ACCOUNT</h2>
                        <div className="mb-4">
                            <div className="text-3xl font-bold text-green-600 number-mono">
                                ${taxSavingsBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </div>
                            <div className="text-sm text-gray-600">Current balance</div>
                        </div>

                        <div className="text-sm text-gray-600">
                            Recent activity shown in Dashboard and History screens
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================================================
        // EXPENSES COMPONENT
        // ============================================================================

        function Expenses({ appData, updateExpenses, updateSettings }) {
            const [showMonthlyBreakdown, setShowMonthlyBreakdown] = useState(false);
            const [newBillName, setNewBillName] = useState('');
            const [newBillDay, setNewBillDay] = useState(1);

            const handleCsvUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const text = await file.text();
                try {
                    const { budget, dueDates } = await parseExpenseCSV(text);

                    // CSV is the source of truth - use due dates from the file
                    updateExpenses(budget, dueDates);
                    alert('Budget uploaded successfully! ‚úì');
                } catch (error) {
                    alert('Error parsing CSV file. Please check the format.');
                }
            };

            const handleUpdateDueDate = (expense, day) => {
                updateExpenses(appData.expenses.budget, {
                    ...appData.expenses.dueDates,
                    [expense]: parseInt(day)
                });
            };

            const handleAddBill = () => {
                if (!newBillName.trim()) {
                    alert('Please enter a bill name');
                    return;
                }

                // Add to due dates
                const updatedDueDates = {
                    ...appData.expenses.dueDates,
                    [newBillName]: newBillDay
                };

                // Add to budget with all zeros
                const updatedBudget = {
                    ...appData.expenses.budget,
                    [newBillName]: Array(12).fill(0)
                };

                updateExpenses(updatedBudget, updatedDueDates);
                setNewBillName('');
                setNewBillDay(1);
            };

            // Calculate monthly totals
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyTotals = monthNames.map((_, i) => {
                return Object.values(appData.expenses.budget).reduce((sum, expenseArray) => {
                    return sum + (expenseArray[i] || 0);
                }, 0);
            });

            const currentMonth = new Date().getMonth();
            const nextMonth = (currentMonth + 1) % 12;
            const averageMonthly = monthlyTotals.reduce((sum, val) => sum + val, 0) / 12;
            const totalYear = monthlyTotals.reduce((sum, val) => sum + val, 0);

            // Calculate YTD business for display
            const completedWeeks = appData.weeks.filter(w => w.income !== null);
            const ytdBusiness = completedWeeks.reduce((sum, w) => sum + (w.business || 0), 0);

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h1 className="text-2xl font-bold text-gray-800">üè¢ BUSINESS EXPENSES</h1>
                    </div>

                    {/* Monthly Budget */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">MONTHLY BUDGET</h2>

                        <div className="space-y-3 mb-4">
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Upload or Re-upload Budget CSV
                            </label>
                            <input
                                type="file"
                                accept=".csv"
                                onChange={handleCsvUpload}
                                className="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 cursor-pointer"
                            />
                            <p className="text-xs text-gray-500">
                                Upload a new CSV to update your monthly budget. Due dates will be set to day 1 for new expenses.
                            </p>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => generateExpenseTemplate(appData)}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                                >
                                    {Object.keys(appData.expenses.budget).length > 0
                                        ? 'üì• Download Current Budget'
                                        : 'üì• Download Template'}
                                </button>
                            </div>
                        </div>

                        {Object.keys(appData.expenses.budget).length > 0 && (
                            <>
                                <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <div className="text-sm text-gray-600">Current month ({monthNames[currentMonth]})</div>
                                            <div className="text-2xl font-bold text-gray-800 number-mono">
                                                ${monthlyTotals[currentMonth].toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-sm text-gray-600">Next month ({monthNames[nextMonth]})</div>
                                            <div className="text-2xl font-bold text-gray-800 number-mono">
                                                ${monthlyTotals[nextMonth].toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button
                                    onClick={() => setShowMonthlyBreakdown(!showMonthlyBreakdown)}
                                    className="text-blue-600 hover:underline mb-4"
                                >
                                    {showMonthlyBreakdown ? 'Hide' : 'View'} Monthly Breakdown ‚ñº
                                </button>

                                {showMonthlyBreakdown && (
                                    <div className="p-4 bg-gray-50 rounded-lg">
                                        <h3 className="font-semibold mb-3">2025 MONTHLY EXPENSES</h3>
                                        <div className="grid grid-cols-3 md:grid-cols-6 gap-3 text-sm">
                                            {monthNames.map((month, i) => (
                                                <div key={month} className={i === currentMonth ? 'font-bold' : ''}>
                                                    <div className="text-gray-600">{month}</div>
                                                    <div className="number-mono">
                                                        ${monthlyTotals[i].toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-gray-300">
                                            <div className="flex justify-between">
                                                <span>Average: ${averageMonthly.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}/month</span>
                                                <span>Total 2025: ${totalYear.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>

                    {/* Bill Due Dates */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">BILL DUE DATES</h2>
                        <p className="text-gray-600 mb-4">Due dates are set in your CSV file:</p>

                        <div className="space-y-3 mb-6">
                            {Object.entries(appData.expenses.dueDates).map(([expense, day]) => (
                                <div key={expense} className="flex items-center gap-4">
                                    <span className="flex-1 text-gray-700">{expense}:</span>
                                    <span className="text-lg font-semibold text-gray-800">
                                        Day {day}
                                    </span>
                                    <span className="text-gray-500">of month</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================================================
        // SETTINGS COMPONENT
        // ============================================================================

        function Settings({ appData, updateSettings, setAppData }) {
            const [editMode, setEditMode] = useState(false);
            const [formData, setFormData] = useState({
                tax2024Total: appData.settings.tax2024Total,
                standardDeduction: appData.settings.standardDeduction,
                businessName: appData.settings.businessName,
                startDate: appData.settings.startDate
            });
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isInstalled, setIsInstalled] = useState(false);
            const [catchUpCsvFile, setCatchUpCsvFile] = useState(null);

            // Listen for install prompt
            React.useEffect(() => {
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

                // Check if already installed
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    setIsInstalled(true);
                }

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                };
            }, []);

            const handleInstallClick = async () => {
                if (!deferredPrompt) {
                    alert('App is already installed or install prompt is not available.');
                    return;
                }

                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;

                if (outcome === 'accepted') {
                    setDeferredPrompt(null);
                    setIsInstalled(true);
                }
            };

            const handleSave = () => {
                updateSettings({
                    tax2024Total: parseFloat(formData.tax2024Total),
                    quarterlyPayment: Math.round(parseFloat(formData.tax2024Total) / 4),
                    standardDeduction: parseFloat(formData.standardDeduction),
                    businessName: formData.businessName,
                    startDate: formData.startDate
                });
                setEditMode(false);
                alert('Settings saved! ‚úì');
            };

            const handleClearData = () => {
                if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                    if (confirm('Really sure? This will delete everything!')) {
                        localStorage.removeItem(STORAGE_KEY);
                        window.location.reload();
                    }
                }
            };

            const handleCatchUpCsvUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setCatchUpCsvFile(file);

                // Parse CSV file
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            // Detect CSV format by checking headers
                            const headers = results.meta.fields || [];
                            const hasTax = headers.some(h => h.toLowerCase() === 'tax');
                            const hasPaycheck = headers.some(h => h.toLowerCase() === 'paycheck');
                            const is4Column = hasTax && hasPaycheck;

                            const weekDataToImport = [];
                            let errorMessages = [];

                            results.data.forEach((row, index) => {
                                const weekStr = (row.Week || row.week || '').toString().trim();
                                const week = parseInt(weekStr);

                                const incomeStr = (row.Income || row.income || '').toString().trim();
                                const cleanedIncome = incomeStr.replace(/[$,\s]/g, '');
                                const income = parseFloat(cleanedIncome);

                                if (isNaN(week) || week < 1 || week > 52) {
                                    errorMessages.push(`Row ${index + 2}: Invalid week number "${weekStr}"`);
                                    return;
                                }

                                if (isNaN(income) || income < 0) {
                                    errorMessages.push(`Row ${index + 2}: Invalid income "${incomeStr}"`);
                                    return;
                                }

                                const weekData = { week, income };

                                if (is4Column) {
                                    const taxStr = (row.Tax || row.tax || '0').toString().trim();
                                    const cleanedTax = taxStr.replace(/[$,\s]/g, '');
                                    const tax = parseFloat(cleanedTax) || 0;

                                    const paycheckStr = (row.Paycheck || row.paycheck || '0').toString().trim();
                                    const cleanedPaycheck = paycheckStr.replace(/[$,\s]/g, '');
                                    const paycheck = parseFloat(cleanedPaycheck) || 0;

                                    if (tax < 0 || paycheck < 0) {
                                        errorMessages.push(`Row ${index + 2}: Tax and Paycheck must be non-negative`);
                                        return;
                                    }

                                    weekData.tax = tax;
                                    weekData.paycheck = paycheck;
                                }

                                weekDataToImport.push(weekData);
                            });

                            if (errorMessages.length > 0) {
                                alert('CSV Upload Errors:\n\n' + errorMessages.join('\n'));
                                return;
                            }

                            if (weekDataToImport.length === 0) {
                                alert('No valid data found in CSV.');
                                return;
                            }

                            // Sort by week number
                            weekDataToImport.sort((a, b) => a.week - b.week);

                            // Calculate balancing for 4-column imports
                            if (is4Column) {
                                const totalIncome = weekDataToImport.reduce((sum, w) => sum + w.income, 0);
                                const totalTax = weekDataToImport.reduce((sum, w) => sum + w.tax, 0);
                                const totalPaycheck = weekDataToImport.reduce((sum, w) => sum + w.paycheck, 0);
                                const totalBusiness = totalIncome - totalTax - totalPaycheck;

                                // Apply business to each week
                                weekDataToImport.forEach((w, index) => {
                                    if (index === weekDataToImport.length - 1) {
                                        // Last week gets all the business
                                        w.business = totalBusiness;
                                    } else {
                                        w.business = 0;
                                    }
                                });
                            }

                            // Update the app data
                            const updatedWeeks = [...appData.weeks];
                            weekDataToImport.forEach(importWeek => {
                                const weekIndex = updatedWeeks.findIndex(w => w.week === importWeek.week);
                                if (weekIndex !== -1) {
                                    if (is4Column) {
                                        updatedWeeks[weekIndex] = {
                                            ...updatedWeeks[weekIndex],
                                            income: importWeek.income,
                                            business: importWeek.business,
                                            tax: importWeek.tax,
                                            paycheck: importWeek.paycheck,
                                            status: 'completed'
                                        };
                                    } else {
                                        // For 2-column, we'd need to calculate splits
                                        // For now, just update income
                                        updatedWeeks[weekIndex] = {
                                            ...updatedWeeks[weekIndex],
                                            income: importWeek.income,
                                            status: 'pending'
                                        };
                                    }
                                }
                            });

                            setAppData({ ...appData, weeks: updatedWeeks });

                            if (is4Column) {
                                alert(`Successfully imported ${weekDataToImport.length} week(s) in Historical format!\n\nWeek ${weekDataToImport[weekDataToImport.length - 1].week} received the balancing business expense.`);
                            } else {
                                alert(`Successfully imported ${weekDataToImport.length} week(s) in Simple format!\n\nNote: You'll need to complete the calculations for each week from the Dashboard.`);
                            }

                            setCatchUpCsvFile(null);

                        } catch (error) {
                            alert('Error parsing CSV: ' + error.message);
                        }
                    },
                    error: (error) => {
                        alert('Error reading CSV file: ' + error.message);
                    }
                });
            };

            const handleImportBackup = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Version checking
                        const importVersion = data.version || 'unknown';
                        console.log(`Importing backup - Version: ${importVersion}, Current: ${STORAGE_VERSION}`);

                        // Warn if version mismatch (future-proofing)
                        if (importVersion !== STORAGE_VERSION && importVersion !== 'unknown') {
                            const proceed = confirm(
                                `This backup is from version ${importVersion}, but you're running version ${STORAGE_VERSION}.\n\n` +
                                `The import may work, but there could be compatibility issues.\n\n` +
                                `Do you want to proceed?`
                            );
                            if (!proceed) return;
                        }

                        setAppData(data);
                        alert(`Backup imported successfully! ‚úì${importVersion !== 'unknown' ? `\n(Version: ${importVersion})` : ''}`);
                    } catch (error) {
                        alert('Error importing backup. Please check the file format.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h1 className="text-2xl font-bold text-gray-800">‚öôÔ∏è SETTINGS</h1>
                    </div>

                    {/* Tax Settings */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">TAX SETTINGS</h2>

                        {!editMode ? (
                            <div className="space-y-3">
                                <div>
                                    <div className="text-sm text-gray-600">2024 Total Tax</div>
                                    <div className="text-lg font-semibold number-mono">
                                        ${appData.settings.tax2024Total.toLocaleString()}
                                    </div>
                                </div>
                                <div>
                                    <div className="text-sm text-gray-600">Quarterly Payment Amount</div>
                                    <div className="text-lg font-semibold number-mono">
                                        ${appData.settings.quarterlyPayment.toLocaleString()}
                                    </div>
                                </div>
                                <div>
                                    <div className="text-sm text-gray-600">Standard Deduction (2024)</div>
                                    <div className="text-lg font-semibold number-mono">
                                        ${appData.settings.standardDeduction.toLocaleString()}
                                    </div>
                                </div>
                                <button
                                    onClick={() => setEditMode(true)}
                                    className="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                >
                                    Edit Settings
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm text-gray-600 mb-1">2024 Total Tax</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-3 text-gray-500">$</span>
                                        <input
                                            type="number"
                                            value={formData.tax2024Total}
                                            onChange={(e) => setFormData({ ...formData, tax2024Total: e.target.value })}
                                            className="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-600 mb-1">Standard Deduction (2024)</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-3 text-gray-500">$</span>
                                        <input
                                            type="number"
                                            value={formData.standardDeduction}
                                            onChange={(e) => setFormData({ ...formData, standardDeduction: e.target.value })}
                                            className="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={handleSave}
                                        className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        Save Changes
                                    </button>
                                    <button
                                        onClick={() => {
                                            setEditMode(false);
                                            setFormData({
                                                tax2024Total: appData.settings.tax2024Total,
                                                standardDeduction: appData.settings.standardDeduction,
                                                businessName: appData.settings.businessName,
                                                startDate: appData.settings.startDate
                                            });
                                        }}
                                        className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Import Past Weeks */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-2">üì• IMPORT PAST WEEKS</h2>
                        <p className="text-gray-600 mb-6">
                            Switching from a spreadsheet or catching up on several weeks? Import your data all at once.
                        </p>

                        <div className="space-y-5">
                            {/* Step 1: Choose Template */}
                            <div>
                                <h3 className="font-semibold text-gray-800 mb-3">Step 1: Download the right template for your situation</h3>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {/* Quick Catch-Up */}
                                    <div className="border-2 border-gray-300 rounded-lg p-4 hover:border-blue-400 transition-colors">
                                        <div className="flex items-start gap-2 mb-2">
                                            <span className="text-2xl">‚ö°</span>
                                            <div className="flex-1">
                                                <h4 className="font-semibold text-gray-800">Quick Catch-Up</h4>
                                                <p className="text-sm text-gray-600 mb-3">
                                                    I just have my income amounts for each week
                                                </p>
                                                <button
                                                    onClick={() => {
                                                        const template = 'Week,Income\n1,2500\n2,2800\n3,2600';
                                                        const blob = new Blob([template], { type: 'text/csv' });
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement('a');
                                                        a.href = url;
                                                        a.download = 'catch-up-template.csv';
                                                        a.click();
                                                        URL.revokeObjectURL(url);
                                                    }}
                                                    className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                                                >
                                                    Download Template
                                                </button>
                                                <p className="text-xs text-gray-500 mt-2">
                                                    The app will calculate your tax savings and paycheck splits for you
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Full Migration */}
                                    <div className="border-2 border-blue-300 rounded-lg p-4 bg-blue-50">
                                        <div className="flex items-start gap-2 mb-2">
                                            <span className="text-2xl">üìä</span>
                                            <div className="flex-1">
                                                <h4 className="font-semibold text-gray-800">Full Migration</h4>
                                                <p className="text-sm text-gray-600 mb-3">
                                                    I have income + what I actually withdrew for taxes and paychecks
                                                </p>
                                                <button
                                                    onClick={() => {
                                                        const template = 'Week,Income,Tax,Paycheck\n1,715.19,0,0\n2,2242.42,0,0\n8,2687.03,2000.00,7911.74';
                                                        const blob = new Blob([template], { type: 'text/csv' });
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement('a');
                                                        a.href = url;
                                                        a.download = 'migration-template.csv';
                                                        a.click();
                                                        URL.revokeObjectURL(url);
                                                    }}
                                                    className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                                                >
                                                    Download Template
                                                </button>
                                                <p className="text-xs text-gray-500 mt-2">
                                                    Perfect for migrating from another system ‚Äî your business expenses will be calculated automatically
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Step 2: Fill & Upload */}
                            <div className="border border-gray-300 rounded-lg p-4">
                                <h3 className="font-semibold text-gray-800 mb-2">Step 2: Fill in your data and upload</h3>
                                <p className="text-sm text-gray-600 mb-3">
                                    Open the template in Excel or Google Sheets, add your weeks, then upload it here:
                                </p>
                                <label className="block">
                                    <input
                                        type="file"
                                        accept=".csv"
                                        onChange={handleCatchUpCsvUpload}
                                        className="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer"
                                    />
                                </label>
                                {catchUpCsvFile && (
                                    <p className="text-sm text-green-700 mt-2">
                                        ‚úì Loaded: {catchUpCsvFile.name}
                                    </p>
                                )}
                            </div>

                            {/* Help text */}
                            <div className="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                <p className="text-xs text-gray-600">
                                    <strong>üí° Tip:</strong> The template shows example data. Delete the example rows and add your own weeks. Save as CSV when done.
                                </p>
                            </div>
                        </div>
                    </div>


                    {/* Data Management */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">DATA MANAGEMENT</h2>
                        <div className="space-y-3">
                            <button
                                onClick={() => exportWeeksToCSV(appData.weeks)}
                                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-left"
                            >
                                üì• Export All Data (CSV)
                            </button>
                            <button
                                onClick={exportToJSON}
                                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-left"
                            >
                                üíæ Backup Data (JSON)
                            </button>
                            <div>
                                <label className="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors cursor-pointer block text-left">
                                    üìÇ Import Backup
                                    <input
                                        type="file"
                                        accept=".json"
                                        onChange={handleImportBackup}
                                        className="hidden"
                                    />
                                </label>
                            </div>
                            <button
                                onClick={handleClearData}
                                className="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-left"
                            >
                                üóëÔ∏è Clear All Data (Dangerous!)
                            </button>
                        </div>
                    </div>

                    {/* Install App */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">üì± INSTALL APP</h2>
                        {isInstalled ? (
                            <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <p className="text-green-700">‚úì App is installed! Launch from your home screen or app drawer.</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                <p className="text-gray-600">Install this app on your device for:</p>
                                <ul className="list-disc list-inside text-gray-600 space-y-1 ml-4">
                                    <li>Offline access</li>
                                    <li>Better data persistence</li>
                                    <li>Native app experience</li>
                                    <li>Quick access from home screen</li>
                                </ul>
                                {deferredPrompt ? (
                                    <button
                                        onClick={handleInstallClick}
                                        className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        üì± Install App
                                    </button>
                                ) : (
                                    <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <p className="text-sm text-blue-700">
                                            To install: Open this page in Chrome, Edge, or Safari and look for the "Install" option in your browser menu.
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Business Settings */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">BUSINESS SETTINGS</h2>
                        <div className="space-y-3">
                            <div>
                                <div className="text-sm text-gray-600">Business Name</div>
                                <div className="text-lg font-semibold">{appData.settings.businessName}</div>
                            </div>
                            <div>
                                <div className="text-sm text-gray-600">Start Date</div>
                                <div className="text-lg font-semibold">{appData.settings.startDate}</div>
                            </div>
                        </div>
                    </div>

                    {/* About */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">ABOUT</h2>
                        <div className="space-y-2 text-gray-700">
                            <p className="font-semibold">Alyx Steadman Therapy Income Manager</p>
                            <p className="text-sm">Version 1.0</p>
                            <p className="text-sm">Data stored locally in your browser</p>
                            <p className="text-sm mt-4">
                                Created for managing self-employed therapist income, taxes, and expenses.
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================================================
        // RENDER APP
        // ============================================================================

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, show update prompt
                                    if (confirm('A new version is available! Reload to update?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>